# GraphQL ì±„íŒ… ì„œë¹„ìŠ¤ ë°±ì—”ë“œ

## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ

[![GraphQL](https://img.shields.io/badge/GraphQL-E10098?style=flat-square&logo=graphql&logoColor=white)](https://graphql.org/)  
[![NestJS](https://img.shields.io/badge/NestJS-E0234E?style=flat-square&logo=nestjs&logoColor=white)](https://nestjs.com/) [![Apollo](https://img.shields.io/badge/Apollo-311C87?style=flat-square&logo=apollographql&logoColor=white)](https://www.apollographql.com/) [![NodeJS](https://img.shields.io/badge/Node.js-6DA55F?style=flat-square&logo=node.js&logoColor=white)](https://nodejs.org/ko) [![TypeScript](https://img.shields.io/badge/TypeScript-3178C6?style=flat-square&logo=typescript&logoColor=white)](https://www.typescriptlang.org/)  
[![Redis](https://img.shields.io/badge/Redis-FF4438?style=flat-square&logo=redis&logoColor=white)](https://redis.io) [![DynamoDB](https://img.shields.io/badge/DynamoDB-4053D6?style=flat-square&logo=amazondynamodb&logoColor=white)](https://aws.amazon.com/ko/dynamodb/) [![Elasticsearch](https://img.shields.io/badge/ElasticSearch-005571?style=flat-square&logo=elasticsearch&logoColor=white)](https://www.elastic.co/kr/elasticsearch)  
[![ESLint](https://img.shields.io/badge/ESLint-4B32C3?style=flat-square&logo=eslint&logoColor=white)](https://eslint.org/) [![Prettier](https://img.shields.io/badge/Prettier-F7B93E?style=flat-square&logo=prettier&logoColor=black)](https://prettier.io/) [![Voyager](https://img.shields.io/badge/ğŸ›°ï¸_Voyager-548f9e?style=flat-square&logoColor=white)](https://github.com/APIs-guru/graphql-voyager)  
[![Docker Compose](https://img.shields.io/badge/Docker_Compose-2AB4FF.svg?logo=data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MjMgNjY1Ij4KICA8cGF0aCBmaWxsPSIjZmNmY2ZjIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik00MTggMWMtNiAxLTkgMy0xMyA4LTQgMy00IDMtMTAgMS0xMi02LTYwIDAtNjYgOC01IDYtMTEgNDQtOCA1MGwyMyAxN2M3IDQgNyA2IDIgNy0yMyAzLTM3IDI5LTI5IDUyIDMgOSAzIDktMTAgNi0xOS01LTI0LTYtNDUtNS00NyAwLTg2IDE4LTEwOSA1MGExMzUgMTM1IDAgMCAwLTI0IDY0Yy0zIDI4IDIgNDggMTcgNzJsMjIgMjdjNDAgNDQgNDEgNjYgMyA5MS00NSAzMC0xMDQgMTktMTA2LTIwLTEtMTYgNC0yOSAxNy01MiAxMy0yNCAxNC0zMyAzLTUybDEzLThjMjQtMTIgMjItOSAyMy0zNCAwLTIyIDItMjAtMjMtMzAtMTgtNi0yMC02LTQwLTEtMjggOS00MCAxNC00MSAxOCAwIDItMSAzLTIgMy03IDAtMTQgMTItMTUgMjUtMSAyMSA2IDI5IDMwIDM2IDMwIDkgMzUgMjQgMTkgNDktMzYgNTMtMzIgMTAyIDExIDEyMSAzNSAxNiA3NCAxMyAxMTktOWwxMS01IDMgMzJjMCAzNC00MCAzOC04OSA4bC0xNi0xMGMtNTEtMjktMTAyIDI0LTY2IDcwIDE1IDIwIDQyIDIxIDQ2IDIgMi04IDAtMTEtMTAtMTktMTYtMTItMTctMjQtMi0yNyA1LTEgMjYgOCAyOCAxMmwzNCAyOSAyMCAxMiAyMCA4YzM2IDEzIDgyLTE1IDgyLTUwIDAtMTAgMC0xMCA2LTUgMTAgMTAgMTggMTYgMjMgMTkgNiAzIDYgNCAxIDctNSAyLTUgMi01IDctMSA4IDEgMjkgNCAzMyA0IDcgNjMgNDYgNjkgNDYgMyAwIDQ4LTI1IDUxLTI5IDItMSAzLTM0IDEtMzZsLTE2LTljLTE2LTgtMTYtOC05LTEwIDE5LTcgMzctMjcgNDMtNDdsNS0xYTE2NSAxNjUgMCAwIDAgNjAtMTNjOSAwIDM0LTIyIDQwLTM0bDQtOGM0LTcgNi0yNiA2LTU2IDAtMjkgMS0yNy0xMC0yOS02LTItOC0zLTEzLTgtMzAtMjktNzktMjMtOTYgMTAtMyA3LTMgNy04IDlzLTYgNS01IDE3djE1YzEgMTQgNCAxNiAzNCAyOGwxMiA2YzcgMyA3IDMgMzAtNyA4LTMgOS0zIDkgMS02IDIyLTY0IDQyLTczIDI0YTg3IDg3IDAgMCAwLTYzLTQyYy04IDAtOCAwIDYtMTFhNzM2IDczNiAwIDAgMCA4NS04OWwzLTVjMTktMzEgMjEtNzMgMy0xMDctNy0xNS0yMy0zNS0zNi00OC0zOS0zNi00Ni00Ny0zOC02MiA0LTggMTUtMTcgMjAtMTVhNDUyIDQ1MiAwIDAgMCA1NS0xMmMxMS00IDEzLTUgMTQtMTAgMC00IDItNyA5LTE0IDI0LTI2LTgtODAtNDMtNzFNMjI4IDMzNGMxIDEgMCAxLTEgMS0yMCAwLTI4IDMyLTEyIDQyIDE3IDkgMzctMyAzNy0yMiAwLTctNy0xNy0xMS0xN3YtMWMzLTIgMC0zLTctNGwtNiAxbTU0IDgtNCAxYy0yMiAzLTI1IDM5LTMgNDQgMjQgNSA0MS0yMSAyNS0zOGwtNS0zdi0zYy0xLTItMTQtMy0xMy0xbS00OSAxMjBjLTYgNy05IDE0LTkgMjQgMCA4IDEgMTIgMyA2IDItMTIgOC0yOCAxMy0zM3YtM2MtMSAwLTQgMi03IDZtOTcgNGMwIDIgMjMgMTcgMjcgMTcgMiAwIDEtMy00LTctOS03LTIzLTEzLTIzLTEwbS01NCA2Yy0yMSA1MSAyOSA5NiA3MyA2NyA4LTYgOC03LTEtOC0zOS0zLTYzLTIzLTY2LTU0LTItMTItMy0xMy02LTUiLz4KPC9zdmc+Cg==&style=flat-square&logoColor=black)](https://docs.docker.com/compose/) [![Docker](https://img.shields.io/badge/Docker-2496ED?style=flat-square&logo=Docker&logoColor=white)](https://www.docker.com/)

## ğŸ’¡ ì£¼ìš” ê¸°ëŠ¥

| ê¸°ëŠ¥ | ì„¤ëª… | ì¿¼ë¦¬(Query) / ìš”ì²­(Mutation) | êµ¬ë…(Subscription) |
| --- | --- | --- | --- |
| ì‚¬ìš©ì ë“±ë¡ | ìœ ì €ID &harr; ì†Œì¼“ID ë§¤í•‘ | mutation setUser<br>(id: String!): Boolean! | subscription userPresence: [String!]! |
| ë°© ìƒì„± | ë°© ê°ì²´ ìƒì„± &rarr;<br> ì°¸ê°€ì ì´ˆëŒ€ ì´ë²¤íŠ¸ ë°œìƒ | mutation createRoom<br>(hostId: String!, participants: [String!]!): String! | subscription roomCreated<br>(userId: String!): Room! |
| ë°© ì°¸ê°€ | ë°©ì— ì‚¬ìš©ì ì¶”ê°€ &rarr;<br> ì°¸ê°€ì ì´ˆëŒ€ ì´ë²¤íŠ¸ ë°œìƒ | mutation joinRoom<br>(roomId: String!, userId: String!): Boolean! | subscription roomCreated<br>(userId: String!): Room! |
| ë°© ë– ë‚˜ê¸° | ë°©ì—ì„œ ì‚¬ìš©ì ì œê±° &rarr;<br> ë– ë‚¨ ì•Œë¦¼ | mutation leaveRoom<br>(roomId: String!, userId: String!): Boolean! | subscription system<br>(input: SystemInput!): Message! |
| ë©”ì‹œì§€ êµí™˜ | ë°©ì—ì„œ ë©”ì‹œì§€ ì¤‘ê³„ | mutation message<br>(content: String!, roomId: String!, userId: String!):<br> Boolean! | subscription message<br>(roomId: String!): Message! |
| íƒ€ì´í•‘ ì•Œë¦¼ | ë°©ì—ì„œ íƒ€ì´í•‘ ì´ë²¤íŠ¸ ì¤‘ê³„ | mutation typing<br>(roomId: String!, userId: String!): Boolean! | subscription typing<br>(roomId: String!): Message! |
| ë©”ì‹œì§€ ê¸°ë¡ <br>ë¶ˆëŸ¬ì˜¤ê¸° | ë°© ì°¸ê°€ ì „ ë©”ì‹œì§€ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° | query history(roomId: String!): [Message!]! |  |
| ë©”ì‹œì§€ ê²€ìƒ‰ | í‚¤ì›Œë“œë¡œ ë©”ì‹œì§€ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° | query search<br>(keyword: String!, userId: String!): [Message!]! |  |

## ğŸ›°ï¸ GraphQL Schema Diagram

> GraphQL VoyagerëŠ” GraphQL ìŠ¤í‚¤ë§ˆë¥¼ ì‹œê°ì ìœ¼ë¡œ íƒìƒ‰í•˜ê³  êµ¬ì¡°ë¥¼ ì´í•´í•  ìˆ˜ ìˆë„ë¡ ë•ëŠ” ì •ì /ì¸í„°ë™í‹°ë¸Œ ì‹œê°í™” ë„êµ¬  
> íƒ€ì…ê³¼ íƒ€ì… ê°„ ì°¸ì¡°ë¥¼ ê·¸ë˜í”„ í˜•íƒœë¡œ í‘œí˜„

| [![voyager](https://github.com/user-attachments/assets/91d13616-99d2-416c-aef8-9462a21ae382)](https://narcisource.github.io/Chat-Service--Backend/) |
| --- |
| [GraphQL Voyager ë°”ë¡œê°€ê¸°](https://narcisource.github.io/Chat-Service--Backend/) |

```mermaid
classDiagram
  direction LR

  class Message {
    +content : String
    +roomId : String!
    +userId : String!
  }

  class Room {
    +participants : [String!]!
    +roomId : String!
  }

  class SystemInput {
    +roomId : String
    +userId : String
  }

  class Query {
    +users() : [String!]!
    +history(roomId: String!) : [Message!]!
    +search(keyword: String!, userId: String!) : [Message!]!
  }

  class Mutation {
    +createRoom(hostId: String!, participants: [String!]!) : String!
    +joinRoom(roomId: String!, userId: String!) : Boolean!
    +leaveRoom(roomId: String!, userId: String!) : Boolean!
    +message(content: String!, roomId: String!, userId: String!) : Boolean!
    +setUser(id: String!) : Boolean!
    +typing(roomId: String!, userId: String!) : Boolean!
  }

  class Subscription {
    +message(roomId: String!) : Message!
    +roomCreated(userId: String!) : Room!
    +system(input: SystemInput!) : Message!
    +typing(roomId: String!) : Message!
    +userPresence : [String!]!
  }

  %% ê´€ê³„
  Mutation --> Room : create/join/leave
  Mutation --> Message : send
  Subscription --> Message : publishes
  Subscription --> Room : publishes
  Subscription --> SystemInput : uses
  Message --> Room : belongs to
  Query --> Message : get
```

## ğŸ“ Sequence Diagram

```mermaid
sequenceDiagram
  participant Web1
  participant Web2
  participant APIGateway@{ "type" : "queue" }
  participant Servers@{ "type" : "collections" }
  participant RedisStore@{ "type": "database" }
  participant RedisPubSub@{ "type" : "queue" }
  participant RedisStreams@{ "type" : "queue" }
  participant DynamoDB@{ "type" : "database" }
  participant Elasticsearch@{ "type" : "database"}

  activate Servers

  %% muation %%
  rect rgba(155, 198, 142, 0.7)
    Web1 ->> APIGateway: mutation setUser(id)
    APIGateway ->> Servers: forward
    Servers ->> RedisStore: store
  end

  %% êµ¬ë… %%
  rect rgb(191, 223, 255, 0.7)
    Web1 ->> APIGateway: subscription roomCreated(userId)
    APIGateway ->> Servers:
    Servers ->> RedisPubSub: subscribe
  end

  par For each room
    rect rgba(155, 198, 142, 0.7)
      Web1 ->> APIGateway: mutation createRoom(hostId, participants)
      APIGateway ->> Servers:
      Servers ->> RedisStore: [roomId, members]
      Servers ->> RedisPubSub: publish roomCreated(room)
      RedisPubSub ->> RedisPubSub: publish
    end

    opt Room created
      rect rgba(155, 198, 142, 0.7)
        Web2 ->> APIGateway: mutation joinRoom(roomId, userId)
        APIGateway ->> Servers:
        Servers ->> RedisPubSub: publish roomCreated(room)
      end

      rect rgb(233, 191, 201, 0.7)
        Web2 ->> APIGateway: query history(roomId)
        APIGateway ->> Servers:
        Servers ->> DynamoDB: getMessageHistory()
        DynamoDB -->> Servers: MessageHistory
        Servers -->> APIGateway:
        APIGateway -->> Web2: [messages]
      end

      rect rgb(191, 223, 255, 0.7)
        Web1 ->> APIGateway: subscription message(roomId)
        Web2 ->> APIGateway:
        APIGateway ->> Servers:
        Servers ->> RedisStreams: subscribe

        Web1 ->> APIGateway: subscription typing(roomId)
        Web1 ->> APIGateway: subscription system(input)
        APIGateway ->> Servers:
        Servers ->> RedisPubSub: subscribe
      end

      rect rgba(155, 198, 142, 0.7)
        loop Multiple events
          Web1 ->> APIGateway: mutation message(roomId, userId, content)
          APIGateway ->> Servers:
          Servers ->> RedisStreams: publish message(message)
          RedisStreams ->> RedisStreams: publish

          rect rgba(255,235,200,0.7)
            loop Sync Consumer
              RedisStreams ->> DynamoDB: store
              RedisStreams ->> Elasticsearch: indexing
            end
          end

          Web1 ->> APIGateway: mutation typing(roomId, userId)
          APIGateway ->> Servers:
          Servers ->> RedisPubSub: publish typing(ping)
          RedisPubSub ->> RedisPubSub: publish
        end
      end
    end

  and Search
    rect rgb(233, 191, 201, 0.7)
      Web1 ->> APIGateway: query search(userId, keyword)
      APIGateway ->> Servers:
      Servers ->> Elasticsearch: searchByKeyword()
      Elasticsearch -->> Servers: search result
      Servers -->> APIGateway:
      APIGateway -->> Web1: [messages]
    end

  and Sync GraphQL Subscriptions
    rect rgba(255,235,200,0.7)
      RedisStreams -->> Servers: asyncIterator
      RedisPubSub -->> Servers: asyncIterator
      Servers -->> APIGateway: push
      APIGateway -->> Web1: [roomCreated| message | typing | system]
      APIGateway -->> Web2:
    end
  end
  deactivate Servers
```

## ğŸ“‚ í´ë” êµ¬ì¡°

<details>
<summary>ì—´ê¸°</summary>

```
server
â”œâ”€ .env
â”œâ”€ docs
â”‚  â””â”€ index.html
â”œâ”€ graphql
â”‚  â””â”€ schema.gql
â”œâ”€ src
â”‚  â”œâ”€ main.ts
â”‚  â”œâ”€ common
â”‚  â”‚  â”œâ”€ graphql
â”‚  â”‚  â”‚  â”œâ”€ index.ts
â”‚  â”‚  â”‚  â””â”€ module.ts
â”‚  â”‚  â”œâ”€ redis
â”‚  â”‚  â”‚  â”œâ”€ index.ts
â”‚  â”‚  â”‚  â”œâ”€ module.ts
â”‚  â”‚  â”‚  â””â”€ providers
â”‚  â”‚  â”‚     â”œâ”€ index.ts
â”‚  â”‚  â”‚     â”œâ”€ storage.ts
â”‚  â”‚  â”‚     â”œâ”€ pubsub.ts
â”‚  â”‚  â”‚     â””â”€ streams.ts
â”‚  â”‚  â”œâ”€ dynamo
â”‚  â”‚  â”‚  â”œâ”€ index.ts
â”‚  â”‚  â”‚  â”œâ”€ module.ts
â”‚  â”‚  â”‚  â””â”€ provider.ts
â”‚  â”‚  â”œâ”€ es
â”‚  â”‚  â”‚  â”œâ”€ index.ts
â”‚  â”‚  â”‚  â”œâ”€ module.ts
â”‚  â”‚  â”‚  â””â”€ provider.ts
â”‚  â”‚  â””â”€ symbols.ts
â”‚  â”œâ”€ model
â”‚  â”‚  â”œâ”€ Message.ts
â”‚  â”‚  â”œâ”€ Room.ts
â”‚  â”‚  â””â”€ schemaDefinition.ts
â”‚  â”œâ”€ core
â”‚  â”‚  â”œâ”€ controller.ts
â”‚  â”‚  â””â”€ module.ts
â”‚  â”œâ”€ domain
â”‚  â”‚  â”œâ”€ shared
â”‚  â”‚  â”‚  â””â”€ events
â”‚  â”‚  â”‚     â”œâ”€ index.ts
â”‚  â”‚  â”‚     â”œâ”€ PubSubPublish.event.ts
â”‚  â”‚  â”‚     â”œâ”€ PubSubPublish.handler.ts
â”‚  â”‚  â”‚     â”œâ”€ StreamsPublish.event.ts
â”‚  â”‚  â”‚     â””â”€ StreamsPublish.handler.ts
â”‚  â”‚  â”œâ”€ user
â”‚  â”‚  â”‚  â”œâ”€ index.ts
â”‚  â”‚  â”‚  â”œâ”€ module.ts
â”‚  â”‚  â”‚  â”œâ”€ model.ts
â”‚  â”‚  â”‚  â”œâ”€ queries
â”‚  â”‚  â”‚  â”‚  â”œâ”€ index.ts
â”‚  â”‚  â”‚  â”‚  â””â”€ GetUsers.query.ts
â”‚  â”‚  â”‚  â”‚     â””â”€ GetUsers.handler.ts
â”‚  â”‚  â”‚  â”œâ”€ commands
â”‚  â”‚  â”‚  â”‚  â”œâ”€ index.ts
â”‚  â”‚  â”‚  â”‚  â”œâ”€ DisconnectUser.command.ts
â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€ DisconnectUser.handler.ts
â”‚  â”‚  â”‚  â”‚  â””â”€ RegisterUser.command.ts
â”‚  â”‚  â”‚  â”‚     â””â”€ RegisterUser.handler.ts
â”‚  â”‚  â”‚  â””â”€ resolvers
â”‚  â”‚  â”‚     â”œâ”€ index.ts
â”‚  â”‚  â”‚     â”œâ”€ query.ts
â”‚  â”‚  â”‚     â”œâ”€ mutation.ts
â”‚  â”‚  â”‚     â””â”€ subscription.ts
â”‚  â”‚  â”œâ”€ chat
â”‚  â”‚  â”‚  â”œâ”€ index.ts
â”‚  â”‚  â”‚  â”œâ”€ model.ts
â”‚  â”‚  â”‚  â”œâ”€ module.ts
â”‚  â”‚  â”‚  â”œâ”€ queries
â”‚  â”‚  â”‚  â”‚  â”œâ”€ index.ts
â”‚  â”‚  â”‚  â”‚  â”œâ”€ GetMessageHistory.query.ts
â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€ GetMessageHistory.handler.ts
â”‚  â”‚  â”‚  â”‚  â”œâ”€ GetPartitions.query.ts
â”‚  â”‚  â”‚  â”‚  â”‚  â””â”€ GetPartitions.handler.ts
â”‚  â”‚  â”‚  â”‚  â””â”€ SearchMessages.query.ts
â”‚  â”‚  â”‚  â”‚     â””â”€ SearchMessages.handler.ts
â”‚  â”‚  â”‚  â””â”€ resolvers
â”‚  â”‚  â”‚     â”œâ”€ index.ts
â”‚  â”‚  â”‚     â”œâ”€ query.ts
â”‚  â”‚  â”‚     â”œâ”€ mutation.ts
â”‚  â”‚  â”‚     â””â”€ subscription.ts
â”‚  â”‚  â””â”€ room
â”‚  â”‚     â”œâ”€ index.ts
â”‚  â”‚     â”œâ”€ model.ts
â”‚  â”‚     â”œâ”€ module.ts
â”‚  â”‚     â”œâ”€ quires
â”‚  â”‚     â”‚  â”œâ”€ index.ts
â”‚  â”‚     â”‚  â””â”€ GetRoomsByUser.query.ts
â”‚  â”‚     â”‚     â””â”€ GetRoomsByUser.handler.ts
â”‚  â”‚     â”œâ”€ commands
â”‚  â”‚     â”‚  â”œâ”€ index.ts
â”‚  â”‚     â”‚  â”œâ”€ CreateRoom.command.ts
â”‚  â”‚     â”‚  â”‚  â””â”€ CreateRoom.handler.ts
â”‚  â”‚     â”‚  â”œâ”€ JoinRoom.command.ts
â”‚  â”‚     â”‚  â”‚  â””â”€ JoinRoom.handler.ts
â”‚  â”‚     â”‚  â””â”€ LeaveRoom.command.ts
â”‚  â”‚     â”‚     â””â”€ LeaveRoom.handler.ts
â”‚  â”‚     â””â”€ resolvers
â”‚  â”‚        â”œâ”€ index.ts
â”‚  â”‚        â”œâ”€ mutation.ts
â”‚  â”‚        â””â”€ subscription.ts
â”‚  â””â”€ repository
â”‚     â”œâ”€ index.ts
â”‚     â”œâ”€ module.ts
â”‚     â””â”€ interface.ts
â”‚        â”œâ”€ InMemoryRepository.ts
â”‚        â””â”€ DatabaseRepository.ts
â”œâ”€ Dockerfile
â”‚  â””â”€ .dockerignore
â”œâ”€ nest-cli.json
â”œâ”€ codegen.introspection.yml # graphQL ìŠ¤í‚¤ë§ˆ ìƒì„± ì •ì˜
â”œâ”€ package.json
â”‚  â””â”€ package-lock.json
â”œâ”€ tsconfig.json
â”‚  â””â”€ tsconfig.build.json
â””â”€ eslint.config.mjs
   â””â”€ .prettierrc
```

</details>

## ğŸš€ ì‹¤í–‰ ë°©ë²•

```sh
$ docker run -d \
  --name redis-container \
  --env-file ./.env \
  -p ${REDIS_PORT}:6379 \
  redis:8.2.1

$ docker run -d \
  --name dynamodb-container \
  --env-file ./.env \
  -p ${DYNAMO_PORT}:8000 \
  amazon/dynamodb-local:3.1.0

$ docker run -d \
  --name es-container \
  --env-file .env \
  -p ${ES_PORT}:9200 \
  docker.elastic.co/elasticsearch/elasticsearch:9.2.0

$ docker build \
  -f Dockerfile \
  -t chat/server:latest \
  .

$ docker run -d \
  --name chat/server \
  --env-file .env \
  -p 3000:3000
  chat/server:latest
```

## ğŸ–¥ï¸ ì ‘ì† ì•ˆë‚´

| í™˜ê²½               | URL                              |
| ------------------ | -------------------------------- |
| server healthcheck | <http://localhost:3000>          |
| graphql schema     | <http://localhost:3000/voyager>â  |
| graphql playground | <http://localhost:3000/graphql>â  |
